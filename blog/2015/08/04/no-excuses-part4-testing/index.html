<!DOCTYPE html>
<html lang="en">
<head>
    <title>No Excuses Part IV: System testing Drupal with a BDD tool (Behat) | Blog of Michelle Krejci</title>
	<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Finally, we will set up some tests. We are going to add Behat for system testing and test our build with each commit on a CI server.">
<link rel="alternate" type="application/rss+xml" title="Blog of Michelle Krejci Feed" href="/rss.xml" />

<link href="/assets/css/bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/font-awesome.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/pygments.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/highlight/default.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/style.css" rel="stylesheet" type="text/css" />

<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@dev_meshev">
<meta name="twitter:title" content="No Excuses Part IV: System testing Drupal with a BDD tool (Behat)">
<meta name="twitter:description" content="Finally, we will set up some tests. We are going to add Behat for system testing and test our build with each commit on a CI server.">
<meta name="twitter:creator" content="@dev_meshev">
<meta name="twitter:image:src" content="http://craychee.io/img/michelle.jpg">
<meta name="twitter:domain" content="craychee.io">

<meta property="og:type" content="blog">
<meta property="og:site_name" content="Blog of Michelle Krejci">
<meta property="og:url" content="/blog/2015/08/04/no-excuses-part4-testing">
<meta property="og:title" content="No Excuses Part IV: System testing Drupal with a BDD tool (Behat)">
<meta property="og:image" content="http://craycheeio/img/michelle.jpg">
</head>
<body>
<nav class="navbar navbar-static-top navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a href="/">Home</a></li>
                <li><a href="/about-craychee/">About</a></li>
                <li><a href="mailto:michelle@craychee.io?Subject=Your blog"><img alt="Email Craychee" src="/img/icon_contact.png" /></a></li>
                <li><a href="http://twitter.com/dev_meshev"><img alt="Craychee's Twitter Account'" src="/img/icon_twitter.png" /></a></li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>


<article>

<div class="section blurred-lines">
    <div class="container">

        <div class="page-header">
        <h1 class="textfill"><span>No Excuses Part IV: System testing Drupal with a BDD tool (Behat)</span></h1>                </div>

    </div>
</div>

<div class="container">

<div class="entry-content">
<p><strong>NOTE</strong> This post is a continuation of <a href="/blog/2015/05/20/no-excuse-config-management-drupal">No Excuses Part I</a>, <a href="/blog/2015/07/29/no-excuses-part2-drupal-config">No Excuses Part II</a>, and <a href="http://craychee.io/blog/2015/08/01/no-excuses-part3-composer/">No Excuses Part III</a>.</p>

<p>Continuous Integration has become synonymous with testing and automation. In order to merge and push code together on a tight iteration, assurances and checkpoints must be built into the system.</p>

<p>But there are other reasons to test. Among them, defining 'done' with a client and translating the definition of done into code so that we can know when a feature is complete. It adds focus to the process, documentation to the project, and regression testing to the project's lifecycle. Making the definition of done executable means you can ask "is it done?" and "has it stayed done?".</p>

<p><a href="http://behat.readthedocs.org/en/v3.0/">Behat</a>, a <a href="http://dannorth.net/whats-in-a-story/">Behavior Driven Development</a> tool, supports this goal.</p>

<p>Today we are going to set Behat up, add a test, and run that test with an automated CI server with every push to github.</p>

<p>Hang onto your butts, this one is going to be an awesomely wild adventure.</p>

<h3 id="step-one%3A-install-and-configure-behat-the-drupal-extension">Step One: Install and Configure Behat (the Drupal Extension)</h3>

<p>With composer already installed (thanks, Ansible), and a <code>composer.json</code> already defined in our project root (see <a href="https://getcomposer.org/doc/01-basic-usage.md#composer-json-project-setup">here</a> if you skipped No Excuses Part III), we only need to add Behat as a dependency.</p>

<p>Update your <code>composer.json</code> so that it includes:</p>

<pre><code class="json">[...]
  "require": {
  [...]
      "drush/drush": "7.*",
      "drupal/drupal-extension": "~3.0"
   },
   "config": {
      "bin-dir": "bin/"
   }
[...]
</code></pre>

<p>From inside your running vagrant box (<code>vagrant up</code> if you shut it down, and <code>vagrant ssh</code> if you are no longer logged in), run <code>composer update</code>. The Drupal Behat Extension and its dependencies will be downloaded. We will get to why we added drush in a bit.</p>

<p>Now we need to add a <a href="http://behat.readthedocs.org/en/v3.0/guides/6.profiles.html">configuration file</a> for Behat. This is what ours will look like:</p>

<pre><code class="yml">default:
  suites:
    default:
      contexts:
      - FeatureContext
      - Drupal\DrupalExtension\Context\DrupalContext
      - Drupal\DrupalExtension\Context\RawDrupalContext
      - Drupal\DrupalExtension\Context\MinkContext
      - Drupal\DrupalExtension\Context\MessageContext
      - Drupal\DrupalExtension\Context\DrushContext
  extensions:
    Behat\MinkExtension:
      goutte: ~
      selenium2:
        wd_host: "http://127.0.0.1:8643/wd/hub"
      base_url: http://localhost
    Drupal\DrupalExtension:
      blackbox: ~
      api_driver: 'drupal'
      drupal:
        drupal_root: 'www'
</code></pre>

<p>Add these contents into a file called <code>behat.yml</code> and save it in your project root.</p>

<p>We just installed the Drupal Extension for Behat. You can and should read more about the extension <a href="http://behat-drupal-extension.readthedocs.org/en/latest/index.html">here</a>. But "I haven't read the docs yet" is an excuse that hasn't held you up before so why start now?</p>

<p>Now run <code>bin/behat --init</code> inside your vagrant box. If successful, you should see:</p>

<pre><code>vagrant@no-excuses:/vagrant$ bin/behat --init
+d features - place your *.feature files here
+d features/bootstrap - place your context classes here
+f features/bootstrap/FeatureContext.php - place your definitions, transformations and hooks here
</code></pre>

<p>These are directories and files that Behat has set up for you. Run <code>bin/behat -dl</code> and you can see all the predefined step definitions that we can use to start writing tests.</p>

<h3 id="step-two%3A-write-our-first-test.">Step Two: Write our first test.</h3>

<p>Let's write a test then.</p>

<p>Inside the <code>features</code> directory that Behat created for you, make a test file called <code>installation.feature</code>. We are going to add a test that verifies a.) the site is up, and b.) that a user can login.
Put this into your newly created file, add this:</p>

<pre><code>@api
Feature: Installation Verification
  As a developer,
  I want to know that my project has installed,
  So that I can smoke test craychee's work.

  Scenario: Verify that the site and its variables are installed.
    Given I am on homepage
    Then I should see the text "Welcome to no-excuses"

  Scenario: Verify that user 1 can log into the site.
    Given I am not logged in
    When I visit "user/login"
    And I fill in "name" with "admin"
    And I fill in "pass" with "admin"
    And I press "Log in"
    Then I should see the link "Log out"
    And I should see the link "Add content"
</code></pre>

<p>Note that the text "Welcome to no-excuses" is the text that I am expecting since "no-excuses" is the name of my example project. This text will be different if you have named you project something other than "no-excuses".</p>

<p>Now let's run this locally. From inside your project's root (inside your vagrant box), run <code>bin/behat</code> and your test suite will run. If your project is built successfully, everything should pass.</p>

<p>This test is a great start because it allows us to verify that our site is built properly and we can log into it as expected. This is especially important if we are testing our build without access to a browser GUI, such as on a CI Server.</p>

<h3 id="step-three%3A-run-that-test-on-a-ci-server">Step Three: Run that test on a CI Server</h3>

<p><strong>Prerequisites setup</strong><br />
You need to have a <a href="https://github.com/">GitHub</a> account.<br />
You need to make <a href="https://help.github.com/articles/create-a-repo/">your project a repository</a> on your GitHub account.<br />
Sign up for a free account on <a href="https://circleci.com/">circleCI</a>.</p>

<p>Great. Now we are going to add some files to explain to circleCI how to build our Drupal project in the same way that we are building our Drupal project locally. I go through a bit more explanation about what I am doing in the <a href="http://craychee.io/blog/2015/04/11/circleci/">previous blog post</a>. For now, you are going to need to just trust me. Yikes.</p>

<p>First, navigate to your <code>cnf</code> directory and create a file called <code>circle.conf</code>. Add these contents:</p>

<pre><code class="conf">&lt;VirtualHost *:80&gt;
    UseCanonicalName Off
    DocumentRoot %HOME%/%PROJECT_DIR%
    ServerName %SERVER%

  &lt;Directory %HOME%/*&gt;
    Options FollowSymLinks
    AllowOverride None
    RewriteEngine On
    RewriteBase /
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule %HOME%/%PROJECT_DIR%/(.*)$ index.php/?q=$1 [L,QSA]
    Order allow,deny
    Allow from all
  &lt;/Directory&gt;

  &lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>This is the webserver configuration for our project, so Apache2 knows where Drupal is.</p>

<p>While still inside <code>cnf</code>, create a file called <code>circle.settings.php</code>. Add these contents:</p>

<pre><code class="php">&lt;?php
$db_url='mysql://ubuntu:@localhost/circle_test';
$databases=array('default' =&gt; array(
    'default' =&gt; array(
        'database' =&gt; 'circle_test',
        'username' =&gt; 'ubuntu',
        'password' =&gt; '',
        'driver' =&gt; 'mysql',
        'host' =&gt; '127.0.0.1',
    ),
),);
require_once DRUPAL_ROOT . '/sites/default/vendor/autoload.php';
</code></pre>

<p>Remember how we set up the build to just copy in the <code>settings.php</code> into Drupal before running site install because the connection information would be different per environment? (Note that you don't need the <code>require_once</code> line if you aren't using Composer to manage Drupal.)</p>

<p>Now return to the project root. Create a file called <code>circle.yml</code> and add these contents:</p>

<pre><code class="yml">machine:
  php:
    version: 5.5.21

dependencies:
  pre:
    - cp $HOME/$CIRCLE_PROJECT_REPONAME/cnf/circle.conf /etc/apache2/sites-available/default
    - sudo sed -e "s?%HOME%?$(pwd)?g" --in-place /etc/apache2/sites-available/default
    - sudo sed -e "s?%PROJECT_DIR%?www?g" --in-place /etc/apache2/sites-available/default
    - echo "sendmail_path=/bin/true" &gt;&gt; ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    - sudo a2enmod rewrite
    - sudo service apache2 restart
    - cp cnf/circle.settings.php cnf/settings.php
  override:
    - composer install --prefer-dist
  post:
    - sudo chown -R $(whoami):www-data www
    - build/install.sh

test:
  override:
      - bin/behat
</code></pre>

<p>These are instructions for circleCI to build our project and, after configuring Apache2, they are identical from our local build: run <code>composer install</code> and then <code>build/install.sh</code> to build the project, then run <code>bin/behat</code> to verify everything is working as expected.</p>

<p>Since circleCI doesn't have Drush installed and our version of Drush, installed with <code>apt-get</code>, is outdated anyway, we added Drush to the project with composer instead. Now we can tell our build to use that version of Drush instead when building our project.</p>

<p>Open your <code>build/install.sh</code> for editing. Where we are setting the <code>drush</code> variable (line 6), change it instead to:</p>

<pre><code class="sh">drush="$base/bin/drush $drush_flags -y -r $base/www"
</code></pre>

<p>Great. Now circleCI will be able to use the same version of Drush that we are.</p>

<p>Make sure all your files are added and pushed to GitHub. (If you are new to GitHub, <a href="https://help.github.com/articles/adding-an-existing-project-to-github-using-the-command-line/">this</a> should get you started.) Go to <a href="https://circleci.com/add-projects">add projects</a>, find your project, and click "Build Project".</p>

<p>Now sit back and watch your project build and test itself.</p>

<p><strong>Want to make sure you followed all of my instructions?</strong>
You can view/fork my no-excuses-example <a href="https://github.com/craychee/no-excuses-Drupal/tree/0.4.0">here</a>.</p>

<h4 id="great-...now-what%3F">Great ...Now what?</h4>

<p>You are going to need to catch yourself up on writing tests for Drupal with Behat. I recommend <a href="https://www.youtube.com/watch?v=i6-940AnZxc">Jack Franks talk</a>.</p>

<p>When should you write tests? Early and often.</p>

<p>Up Next: <strong><a href="/blog/2015/08/08/no-excuses-part5-deployment/">No Excuses Part V: Automated Deployment</a></strong></p>

</div>

</div><!-- .container -->

</article>

<div class="container">

<div class="entry-content">
<h3>What do you think?</h3>
<p>I'd love to hear from you. <a href="mailto:michelle@craychee.io?Subject=Your blog">Contact Michelle</a>.</p>
</div>

</div><!-- .container -->


<footer class="footer inverse">

<div class="container">
    <div class="row">
        <div class="col-xs-12 text-center"><small>Powered by <a href="https://sculpin.io/">Sculpin</a></small></div>
    </div>
</div>

</footer>

<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-61998846-1']);
_gaq.push(['_trackPageview']);

(function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>

<!-- Placed at the end of the document so the pages load faster -->
<script src="/assets/js/augment.min.js"></script>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/respond.min.js"></script>
<script src="/assets/js/jquery.textfill.min.js"></script>
<script src="/assets/js/highlight.pack.js"></script>
<script type="text/javascript">
hljs.initHighlightingOnLoad();
$(function(){
    resizeTextFill();
    $( window ).resize( resizeTextFill );
});
function resizeTextFill()
{
    $('.textfill').textfill({ maxFontPixels: 70, widthOnly: true });
}
</script>
</body>
</html>
